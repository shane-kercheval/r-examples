---
title: ""
author: "Shane Kercheval"
output:
  md_document:
    variant: markdown_github
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
#devtools::install_github('shane-kercheval/rtools')
library(rtools)
# library(scales)
# library(stringr)
library(lubridate)
# library(ggrepel)
# library(forecast)
library(tidyverse)
library(ggplot2)
library(knitr)

options(scipen=999) # non-scientific notation
options(dplyr.summarise.inform=F)

theme_set(theme_light())

calculate_plot_width <- function(plot_height) { plot_height * 1.61803398875 }
plot_width_height_6 <- calculate_plot_width(6)
plot_width_height_7 <- calculate_plot_width(7)
plot_width_height_8 <- calculate_plot_width(8)
```

> A diff-in-diff analysis applies when you have two groups whose pretreatment differences can be isolated and modeled so that post-treatment differences are the basis for causal estimates of the treatment effect. - Business Data Science pg 141

```{r}
# business data science pg 141
sem <- read.csv("data/paidsearch.csv")
sem <- sem %>%
    mutate(date = as.Date(strptime(date, "%d-%b-%y", tz = 'UTC')),
           dma = factor(dma),
           variant = ifelse(search.stays.on == 1, 'Control', 'Treatment')) %>%
    relocate(variant, .after=search.stays.on)
head(sem)
```

Here is the overall data, because the treatment is much smaller in total revenue, it is difficult to see if there is a noticable drop after Adwords was shut off.

```{r message=FALSE, warning=FALSE}
sem %>%
    count(date, variant, wt=revenue, name='revenue') %>%
    ggplot(aes(x=date, y=revenue, color=variant, group=variant)) +
    geom_vline(xintercept = ymd('2012-05-22')) +
    geom_line() +
    scale_x_date() +
    scale_y_continuous(labels=rt_pretty_axes) +
    geom_smooth() +
    labs(title="Daily Revenue",
         subtitle="The 'Control' are the DMAs where adwords will be left on.\nThe 'Treatment' are the DMAs where adwords is turned off.\nWe could expect a drop in the Treatment as compared to the Control.")
```

Using log() makes it easier to visualize.

```{r message=FALSE, warning=FALSE}
sem %>%
    count(date, variant, wt=revenue, name='revenue') %>%
    ggplot(aes(x=date, y=log(revenue), color=variant, group=variant)) +
    geom_vline(xintercept = ymd('2012-05-22')) +
    geom_line() +
    scale_x_date() +
    scale_y_continuous(labels=rt_pretty_axes) +
    geom_smooth()
```

> Here we will focus on differences in `log` revenue because we anticipate that the treatment and control groups are related on percentage scale. BDS pg 143.

```{r message=FALSE, warning=FALSE}
sem %>%
    group_by(date) %>%
    summarise(difference = log(mean(revenue[variant == 'Treatment'])) - log(mean(revenue[variant == 'Control']))) %>%
    ungroup() %>%
    ggplot(aes(x=date, y=difference)) +
    geom_vline(xintercept = ymd('2012-05-22')) +
    geom_line() +
    scale_x_date() +
    scale_y_continuous(labels=rt_pretty_axes) +
    geom_smooth() +
    labs(title = "Log Difference of Average Revenue (Treatment - Control)",
         subtitle = "Decrease indicates a drop in the Treatment compared to the Control",
         y = "Log Difference (Treatment - Control)",
         x = 'Date')
```

Same but using separate `lm` on before vs. after.

```{r message=FALSE, warning=FALSE}
sem %>%
    group_by(date, treatment_period) %>%
    summarise(difference = log(mean(revenue[variant == 'Treatment'])) - log(mean(revenue[variant == 'Control']))) %>%
    ungroup() %>%
    ggplot(aes(x=date, y=difference)) +
    geom_vline(xintercept = ymd('2012-05-22')) +
    geom_line() +
    scale_x_date() +
    scale_y_continuous(labels=rt_pretty_axes) +
    geom_smooth(method='lm', aes(group=treatment_period)) +
    labs(title = "Log Difference of Total Average (Treatment - Control)",
         subtitle = "Decrease indicates a drop in the Treatment compared to the Control",
         y = "Log Difference (Treatment - Control)",
         x = 'Date')
```

## Quick Refresher & Example with Logs

If we would not have used log differences, here is what we would have had. The difference is dominated by the larger group (control).

```{r message=FALSE, warning=FALSE}
sem %>%
    group_by(date, treatment_period) %>%
    summarise(difference = mean(revenue[variant == 'Treatment']) - mean(revenue[variant == 'Control'])) %>%
    ungroup() %>%
    #pivot_longer(-date, names_to=)
    ggplot(aes(x=date, y=difference)) +
    geom_vline(xintercept = ymd('2012-05-22')) +
    geom_line() +
    scale_x_date() +
    scale_y_continuous(labels=rt_pretty_axes) +
    geom_smooth(method='lm', aes(group=treatment_period)) +
    labs(title = "Difference of Total Revenue (Treatment - Control)",
         subtitle = "Note: as compared with log difference, no change in trend is found,\nbecause we are comparing a change within a smaller group to no change in a larger group\n(i.e. additive difference), whereas we want to know the multiplicative difference.",
         y = "Difference (Treatment - Control)",
         x = 'Date')
```

For example, `.y` and `.z` change multiplicatively (actually percent change is the same for each, which you can see in the last graph)

```{r}
.x <- seq(1, 2, .1)
.x <- c(.x, rev(.x))
(.y <- .x * 1000)
(.z <- .y * 1000)
```

Both sequences above have the same percent change.

However, there additive difference doesn't reflect that.

```{r}
.z - .y
```

But when we look at the log differences, it is exactly the same for each value, because each variable is changing at constant rate, and so there log differences are the same... i.e. they change multiplicatively.

```{r}
log(.z) - log(.y)
```

Both differences are graphed below.

```{r}
data.frame(index=1:length(.y), y=.y, z=.z) %>%
    pivot_longer(cols=-index) %>%
    ggplot(aes(x=index, y=value, color=name, group=name)) +
    geom_line()
```

```{r}
data.frame(index=1:length(.y), y=.y, z=.z) %>%
    mutate(differences = z - y) %>%
    ggplot(aes(x=index, y=differences)) +
    geom_line()
```

```{r}
data.frame(index=1:length(.y), y=.y, z=.z) %>%
    mutate(difference = log(z) - log(y)) %>%
    ggplot(aes(x=index, y=difference)) +
    geom_line() +
    labs(y='log differences', 
         subtitle = 'both .x and .y are increasing and decreasing at the same rate')
```

## Create dataset that is basis for regression model.

```{r}
# treatment_period of 0 means < May 22, when the ads were on for both variants (consistance difference is expected)
# treatment_period of 1 means >= May 22, when the ads were shut off for Treatment (potental drop in sales for treatment may be expected)
sem_per_dma <- sem %>%
    group_by(dma, treatment_period, variant) %>%
    summarise(y = mean(log(revenue)), n=n()) %>%
    ungroup() %>%
    mutate(variant = factor(variant, levels=c("Control", "Treatment"))) %>%
    as.data.frame()
head(sem_per_dma)
```

```{r}
reg_results <- lm(y ~ treatment_period * variant, data=sem_per_dma)
summary(reg_results)
```

```{r}
get_regression_equation(reg_results, .round_by = 5)
```

```{r}
(interaction_coeff <- coefficients(reg_results)['treatment_period:variantTreatment'])
(interaction_coeff <- paste0(round(interaction_coeff * 100, 2), '%'))
```

Intercept coefficient is the average log(revenue) of control before applying treatment 

```{r}
sem_per_dma %>%
    filter(variant == 'Control' & treatment_period == 0) %>%
    pull(y) %>%
    mean()
 coefficients(reg_results)['(Intercept)']
```

The coefficient for `treatment_period` is the predicted difference before/after for the `control`

```{r}
sem_per_dma %>%
    filter(variant == 'Control') %>%
    group_by(treatment_period) %>%
    summarise(mean_y = mean(y)) %>%
    ungroup() %>%
    summarise(diff = mean_y[treatment_period == 1] - mean_y[treatment_period == 0]) %>%
    pull(diff)
 coefficients(reg_results)['treatment_period']
```

The coefficient for `treatment_period` is the predicted difference before/after for the `control`

```{r}
sem_per_dma %>%
    filter(variant == 'Control') %>%
    group_by(treatment_period) %>%
    summarise(mean_y = mean(y)) %>%
    ungroup() %>%
    summarise(diff = mean_y[treatment_period == 1] - mean_y[treatment_period == 0]) %>%
    pull(diff)
 coefficients(reg_results)['treatment_period']
```

The coefficient for `variantTreatment` is the predicted difference between the control & variant during the treatment_period of 0.

```{r}
sem_per_dma %>%
    filter(treatment_period == 0) %>%
    group_by(variant) %>%
    summarise(mean_y = mean(y)) %>%
    ungroup() %>%
    summarise(diff = mean_y[variant == 'Treatment'] - mean_y[variant == 'Control']) %>%
    pull(diff)
 coefficients(reg_results)['variantTreatment']
```

The coefficient for `treatment_period:variantTreatment`, is the difference over tim ein the average difference of (average) revenue in the two groups.

```{r}
sem %>%
    group_by(treatment_period, variant) %>%
    summarise(y = mean(log(revenue))) %>%
    ungroup() %>%
    summarise(diff = (y[variant == 'Treatment' & treatment_period == 1] -
                      y[variant == 'Control' & treatment_period == 1]) - 
                     (y[variant == 'Treatment' & treatment_period == 0] -
                      y[variant == 'Control' & treatment_period == 0]))
```

```{r}
coefficients(reg_results)['treatment_period:variantTreatment']
```

```{r}
summary(reg_results)
```

> Note that these rwos of data do not satisfy the standard independence assumption: each two observations on the same DMA will be correlated. ... you can use clustered starndard error, or you can get a similar result by controlling for the DMA-specific revenue levels in the regression equation. BDS pg 144-145

```{r}
reg_results <- lm(y ~ dma + treatment_period * variant, data=sem_per_dma)
reg_results %>%
    tidy() %>%
    filter(!str_detect(term, 'dma'))
```
```
