---
title: "Regression and Other Stories"
author: "Shane Kercheval"
output:
  md_document:
    variant: markdown_github
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
#devtools::install_github('shane-kercheval/rtools')
#library(rtools)
# library(stringr)
# library(ggrepel)
# library(forecast)
#library(scales)
#library(lubridate)

library(knitr)

calculate_plot_width <- function(plot_height) { plot_height * 1.61803398875 }
plot_width_height_5 <- calculate_plot_width(5)
plot_width_height_6 <- calculate_plot_width(6)
plot_width_height_7 <- calculate_plot_width(7)
plot_width_height_8 <- calculate_plot_width(8)
```

```{r downloading_data, eval=FALSE, include=FALSE}
download.file(url='https://raw.githubusercontent.com/avehtari/ROS-Examples/master/ElectionsEconomy/data/hibbs.dat',
              destfile = 'data/hibbs.dat', quiet = TRUE)
```


# Overview

This document includes examples and exercises from `Regression and Other Stories` by Andrew Gelman, Jennifer Hill and Aki Vehtari, 2020, first edition.

# Resources

[Errata](https://avehtari.github.io/ROS-Examples/errata.html)

[Authors' Code](https://avehtari.github.io/ROS-Examples/examples.html#Examples_by_chapters)

# Packages

## statistical packages

```{r message=FALSE, warning=FALSE}
library(rstan)
library(rstanarm)
library(bayesplot)
library(loo)
```

## base packages

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(scales)
```

## Settings

```{r}
theme_set(theme_light())
options(scipen=999) # non-scientific notation
options(dplyr.summarise.inform=F)
```

# Chapter 1

## Simple Example with `stan_glm`

Load in the data:

```{r}
hibbs <- read.table('data/hibbs.dat', header = TRUE)
head(hibbs)
```

---

Graph data:

```{r figure.1.1.a, fig.height=5, fig.width=plot_width_height_5, message=FALSE}
hibbs %>%
    ggplot(aes(x=growth, y=vote)) +
    geom_hline(yintercept = 50, color="red", linetype="dashed") +
    geom_text(aes(label=year)) +
    geom_smooth(method='lm') +
    scale_x_continuous(labels=function(.x)paste0(.x, '%')) +
    scale_y_continuous(labels=function(.x)paste0(.x, '%')) +
    labs(title="Forecasting the election from the economy",
         y="Incuming party's vote share",
         x="Average recent growth in personal",
         caption='Figure 1.1')
```

---

Build Model:

```{r}
model <- stan_glm(vote ~ growth, data=hibbs)
```

---

Model Summary:

```{r}
summary(model)
```

---

Print()

```{r}
print(model)
```

---

Model Coefficients:

```{r}
coef(model)
```

---

Compare to `lm()`:

```{r}
summary(lm(vote ~ growth, data=hibbs))
```

(pretty close)

---

Graph using model coefficients rather than `geom_smooth(method='lm')`

```{r figure.1.1.a2, fig.height=5, fig.width=plot_width_height_5, message=FALSE}
hibbs %>%
    ggplot(aes(x=growth, y=vote)) +
    geom_hline(yintercept = 50, color="red", linetype="dashed") +
    geom_text(aes(label=year)) +
    #geom_smooth(method='lm') +
    geom_abline(intercept = coef(model)['(Intercept)'], slope = coef(model)['growth']) +
    scale_x_continuous(labels=function(.x)paste0(.x, '%')) +
    scale_y_continuous(labels=function(.x)paste0(.x, '%')) +
    labs(title="Forecasting the election from the economy",
         y="Incuming party's vote share",
         x="Average recent growth in personal",
         caption='Figure 1.1')
```

---

# Chapter 3

### Log-Log Interpretation

```{r message=FALSE, warning=FALSE}
metabolic_rate <- read_csv("data/Primate Body Mass and Basal Metabolic Rate.csv")
head(metabolic_rate)
```

```{r chapter_3_log_log_not_scaled, fig.height=5, fig.width=plot_width_height_5, message=FALSE}
metabolic_rate %>%
    ggplot(aes(x=`Primate Mass`, y=`Metabolic Rate`)) +
    geom_point() +
    labs("Primate Body Mass And Basal Metabolic Rate",
         subtitle = "(Not Scaled)")
```

```{r chapter_3_log_log_scaled, fig.height=5, fig.width=plot_width_height_5, message=FALSE}
metabolic_rate %>%
    ggplot(aes(x=`Primate Mass`, y=`Metabolic Rate`)) +
    geom_point() +
    scale_x_log10() +
    scale_y_log10() +
    labs("Primate Body Mass And Basal Metabolic Rate",
         subtitle = "Scaled Log")
```

```{r}
model <- lm(log(`Metabolic Rate`) ~ log(`Primate Mass`), data=metabolic_rate)
summary(model)
```

```{r}
coef(model)
```


```{r}
summary(model)$sigma

```

```{r chapter_3_log_log_scaled_regression, fig.height=5, fig.width=plot_width_height_5, message=FALSE}
all_predictions <- data.frame(`Primate Mass`=seq(50, 80000), check.names = FALSE)
temp_predictions <- predict(model, newdata=all_predictions)

model_residuals <- residuals(model)
length(model_residuals)^-1

duan_smearing_adjustment <- sum(exp(model_residuals)) / length(model_residuals)

all_predictions$predictions_adjusted_simple <- exp(((summary(model)$sigma)^2)/2)*exp(temp_predictions)
all_predictions$predictions_adjusted_duan <- duan_smearing_adjustment*exp(temp_predictions)
all_predictions$predictions_raw <- exp(temp_predictions)

metabolic_rate %>%
    ggplot(aes(x=`Primate Mass`, y=`Metabolic Rate`)) +
    geom_point() +
    scale_x_log10(breaks=10^seq(0, 4)) +
    scale_y_log10() +
    geom_text(aes(label=glue::glue("({ `Primate Mass` }, { `Metabolic Rate` })")), vjust=-0.5) +
    geom_line(data=all_predictions, aes(x=`Primate Mass`, y=predictions_raw), color='blue') +
    geom_line(data=all_predictions, aes(x=`Primate Mass`, y=predictions_adjusted_simple), color='red') +
    geom_line(data=all_predictions, aes(x=`Primate Mass`, y=predictions_adjusted_duan), color='purple') +
    geom_smooth(method='lm') +
    labs("Primate Body Mass And Basal Metabolic Rate",
         subtitle = "Scaled Log")

metabolic_rate %>%
    ggplot(aes(x=`Primate Mass`, y=`Metabolic Rate`)) +
    geom_point() +
    #scale_x_log10(breaks=10^seq(0, 4)) +
    #scale_y_log10() +
    geom_text(aes(label=glue::glue("({ `Primate Mass` }, { `Metabolic Rate` })")), vjust=-0.5) +
    geom_line(data=all_predictions, aes(x=`Primate Mass`, y=predictions_raw), color='blue') +
    geom_line(data=all_predictions, aes(x=`Primate Mass`, y=predictions_adjusted_simple), color='red') +
    geom_line(data=all_predictions, aes(x=`Primate Mass`, y=predictions_adjusted_duan), color='purple') +
    #geom_smooth(method='lm') +
    labs("Primate Body Mass And Basal Metabolic Rate",
         subtitle = "Scaled Log")
```

> "A one-unit difference in `log x` corresponds to an additive difference of `b` in `log y`. (R&OS pg. 39)

This is essentially "elasticity" and is interpreted as a `1%` change in x has a `b`% change in `y` (Intro Econometrics pg. 39), although this does not hold for large changes in `y` (Intro Econometrics pg. 186).

So, the interpretation of the `log(Primate Mass)` coefficient is that a `1%` change in `Primate Mass` results in a `~`r paste0(round(coef(model)["log(`Primate Mass`)"], 2), "%")`` change in `Metabolic Rate`.

Let's see if this is true.

```{r}
(prediction_105 <- predict(model, newdata = data.frame(`Primate Mass`=105, check.names = FALSE)))
```

If the `Primate Mass` is `105` then our prediction of `log(Metabolic Rate`) is ``r prediction_105``

```{r}
exp(prediction_105)
```

Which means our prediction of `Metabolic Rate` is ``r exp(prediction_105)``, which matches the point on the graph.

```{r}
(one_percent_change <- (0.01 * 105) + 105)
(one_percent_change_prediction <- predict(model, newdata = data.frame(`Primate Mass`=one_percent_change, check.names = FALSE)))
one_percent_change_prediction <- exp(one_percent_change_prediction)
```

```{r}
format_percent((one_percent_change_prediction - exp(prediction_105)) / exp(prediction_105))
```

```{r}
coef(model)["log(`Primate Mass`)"]
```

Yep, this works. A `1%` (from `105` to ``r one_percent_change``) change in `Primate Mass` resulted in a `0.74%` change in the predicted `Metabolic Rate`

But lets try with a larger change.

Lets predict `Metabolic Change` for a `Primate Mass` of `9,500`

```{r}
(percent_change <- (9500 - 105) / 105)
format_percent <- function(.x) { paste0(round(.x * 100, 2), '%')}
```

The percent-change in `Primate Mass` between these two values is ``r format_percent(percent_change)``.

```{r}
(expected_percent_change_y <- as.numeric(coef(model)["log(`Primate Mass`)"]) * percent_change)
```

Therefore, the **expected** percent change in `Metabolic Rate` should be ``r format_percent(expected_percent_change_y)``.

But the actual percent change is:

```{r}
(prediction_9500 <- predict(model, newdata = data.frame(`Primate Mass`=9500, check.names = FALSE)))
format_percent((exp(prediction_9500) - exp(prediction_105)) / exp(prediction_105))
```

Which is quite lower.

So this rule of thumb doesn't work across large changes in `y`.

---

Simulate

`log y = b*log x + random-noise`

```{r}
set.seed(3)
simulated_x <- rexp(100000, rate = 0.5) + 4
noise <- rnorm(100000, sd = 0.5)
actual_log_y <- 3*log(simulated_x)
simulated_log_y <- actual_log_y + noise
simulated_y <- exp(simulated_log_y)


simulated_data <- data.frame(simulated_x, simulated_y, actual_log_y)

simulated_data %>%
    ggplot(aes(x=simulated_x, y=simulated_y)) +
    geom_point(alpha=0.1) +
#    geom_line(aes(y=exp(actual_log_y)), color='red') +
    scale_x_log10() +
    scale_y_log10()

training_indices <- sample.int(n=nrow(simulated_data), size = 0.7*nrow(simulated_data), replace = FALSE)
training_data <- simulated_data[training_indices,]
test_data <- simulated_data[-training_indices,]
model <- lm(log(simulated_y) ~ log(simulated_x), data=training_data)
summary(model)
```

```{r chapter_3_log_log_scaled_regression, fig.height=5, fig.width=plot_width_height_5, message=FALSE}
model_residuals <- residuals(model)
(duan_smearing_adjustment <- sum(exp(model_residuals)) / length(model_residuals))

temp_predictions <- predict(model, newdata = test_data)
# only use _simple when residuals are normally distributed, which in this case they are
# so they are actually very close to duan_smearing_adjustment, but in general the smearing adjustment
# is a safer
test_data$predictions_adjusted_simple <- exp(((summary(model)$sigma)^2)/2)*exp(temp_predictions)
test_data$predictions_adjusted_duan <- duan_smearing_adjustment*exp(temp_predictions)
test_data$predictions_raw <- exp(temp_predictions)

test_data %>%
    ggplot(aes(x=simulated_x, y=simulated_y)) +
    geom_point() +
    #geom_smooth(method='lm', se=FALSE) +
    geom_line(aes(y=predictions_raw), color='red') +
    geom_line(aes(y=predictions_adjusted_simple), color='orange') +
    geom_line(aes(y=predictions_adjusted_duan), color='purple')# +
    # scale_x_log10() +
    # scale_y_log10()
```

```{r}
rmse = function(fitted, actual){
  sqrt(mean((fitted - actual)^2))
}

rmse(fitted=test_data$predictions_raw, actual=test_data$simulated_y)
rmse(fitted=test_data$predictions_adjusted_simple, actual=test_data$simulated_y)
rmse(fitted=test_data$predictions_adjusted_duan, actual=test_data$simulated_y)
```

